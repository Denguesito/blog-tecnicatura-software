{% extends "base.html" %}

{% load static %}

{% block banner %}
<section class="banner banner-articulos">
  <div class="banner-content">

  </div>
</section>
{% endblock banner %}

{% block titulo %}Editar Artículo{% endblock titulo %}

{% block contenido %}
<div class="container my-5">
  <h2 class="text-center text-warning mb-4">Editar Artículo</h2>

  <form method="post" enctype="multipart/form-data" class="p-4 border rounded shadow-sm bg-light">
    {% csrf_token %}

   <!-- Título -->
<div class="mb-3">
  {{ form.titulo.label_tag }}
  {{ form.titulo }}
  {% for error in form.titulo.errors %}
    <div class="text-danger small">{{ error }}</div>
  {% endfor %}
</div>

<!-- Contenido -->
<div class="mb-3">
  {{ form.contenido.label_tag }}
  {{ form.contenido }}
  {% for error in form.contenido.errors %}
    <div class="text-danger small">{{ error }}</div>
  {% endfor %}
</div>


    <!-- Input nuevas imágenes -->
    <label for="id_imagenes" class="form-label mt-3">Agregar nuevas imágenes:</label>
    <input type="file" id="id_imagenes" multiple accept="image/*" class="form-control mb-2">
    <div id="previews" class="d-flex flex-wrap gap-2 mb-3"></div>
    <input type="file" name="imagenes" id="imagenes_hidden" style="display:none;" multiple>

    <!-- Imágenes existentes -->
    {% if object.imagenes.all %}
      <h5>Imágenes actuales:</h5>
      <div class="d-flex flex-wrap gap-2 mb-3" id="imagenes_existentes">
        {% for imagen in object.imagenes.all %}
          <div class="position-relative">
            <img src="{{ imagen.imagen.url }}" class="img-thumbnail" style="width:120px;height:120px;object-fit:cover;">
            <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 btn-eliminar" data-id="{{ imagen.pk }}">✕</button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="d-flex gap-2 mt-3">
      <button type="submit" class="btn btn-warning flex-fill">Guardar cambios</button>
      <a href="{% url 'blog:detalle_articulo' object.pk %}" class="btn btn-secondary flex-fill">Cancelar</a>
    </div>
  </form>
</div>

<!-- Preview de nuevas imágenes -->
<script>
(function(){
    const input = document.getElementById('id_imagenes');
    const hidden = document.getElementById('imagenes_hidden');
    const previews = document.getElementById('previews');
    const dt = new DataTransfer();

    function updateHiddenAndPreviews(){
        hidden.files = dt.files;
        previews.innerHTML = '';
        for(let i=0;i<dt.files.length;i++){
            const file = dt.files[i];
            const url = URL.createObjectURL(file);

            const wrapper = document.createElement('div');
            wrapper.classList.add('position-relative');

            const img = document.createElement('img');
            img.src = url;
            img.classList.add('img-thumbnail');
            img.style.width = '120px';
            img.style.height = '120px';
            img.style.objectFit = 'cover';

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.textContent = '✕';
            btn.classList.add('btn', 'btn-sm', 'btn-danger', 'position-absolute', 'top-0', 'end-0');
            btn.style.zIndex = '10';

            btn.addEventListener('click', ()=> {
                const newDt = new DataTransfer();
                for(let j=0;j<dt.files.length;j++){
                    if(j===i) continue;
                    newDt.items.add(dt.files[j]);
                }
                while(dt.items.length) dt.items.remove(0);
                for(let k=0;k<newDt.files.length;k++) dt.items.add(newDt.files[k]);
                updateHiddenAndPreviews();
            });

            wrapper.appendChild(img);
            wrapper.appendChild(btn);
            previews.appendChild(wrapper);
        }
    }

    input.addEventListener('change', (e)=>{
        for(const file of e.target.files){
            dt.items.add(file);
        }
        input.value = '';
        updateHiddenAndPreviews();
    });
})();
</script>

<!-- Eliminar imágenes existentes vía AJAX -->
<script>
document.addEventListener('DOMContentLoaded', function(){
    const contenedor = document.getElementById('imagenes_existentes');
    if(!contenedor) return;

    contenedor.addEventListener('click', function(e){
        if(e.target.classList.contains('btn-eliminar')){
            const idImagen = e.target.dataset.id;
            const wrapper = e.target.parentElement;

            if(confirm('¿Deseas eliminar esta imagen?')){
                fetch("{% url 'blog:eliminar_imagen_articulo' 0 %}".replace('0', idImagen), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Accept': 'application/json',
                    },
                })
                .then(res => res.json())
                .then(data => {
                    if(data.ok){
                        wrapper.remove();
                    } else {
                        alert(data.error || 'No se pudo eliminar la imagen.');
                    }
                })
                .catch(err => alert('Error al eliminar la imagen.'));
            }
        }
    });
});
</script>
{% endblock contenido %}
