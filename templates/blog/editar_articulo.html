{% extends "base.html" %}
{% load static %}

{% block banner %}
<section class="banner banner-articulos">
  <div class="banner-content"></div>
</section>
{% endblock banner %}

{% block titulo %}Editar Artículo{% endblock titulo %}

{% block contenido %}
<div class="container">
  <div class="form-article-card">
    <h2>Editar Artículo</h2>
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}

      {# Mostrar errores generales del form #}
      {% if form.non_field_errors %}
        <div class="alert alert-danger">
          {% for err in form.non_field_errors %}
            <div>{{ err }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <div class="mb-3">
        {{ form.titulo.label_tag }}
        {{ form.titulo }}
        {% for error in form.titulo.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="mb-3">
        {{ form.contenido.label_tag }}
        {{ form.contenido }}
        {% for error in form.contenido.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="mb-3">
        {{ form.categoria.label_tag }}
        {{ form.categoria }}
        {% for error in form.categoria.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>

      <label for="id_imagenes" class="form-label mt-3">Agregar nuevas imágenes:</label>
      <input type="file" id="id_imagenes" name="imagenes" multiple accept="image/*" class="form-control mb-2">
      <div id="previews" class="d-flex flex-wrap gap-2 mb-3"></div>

      {% if object.imagenes.all %}
        <h5>Imágenes actuales:</h5>
        <div class="d-flex flex-wrap gap-2 mb-3" id="imagenes_existentes">
          {% for imagen in object.imagenes.all %}
            <div class="position-relative">
              <img src="{{ imagen.imagen.url }}" class="img-thumbnail"
                  style="width:120px;height:120px;object-fit:cover;">
              <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 btn-eliminar"
                      data-id="{{ imagen.pk }}">✕</button>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <div class="d-flex justify-content-center gap-3 mt-4 flex-wrap">
        <button type="submit" class="btn btn-warning btn-form">Guardar cambios</button>
        <a href="{% url 'blog:detalle_articulo' object.pk %}" class="btn btn-secondary btn-form">Cancelar</a>
      </div>
    </form>
  </div>
</div>

<!-- Scripts: preview de nuevas imágenes y eliminar imágenes existentes -->
<script>
(function(){
    // ---- PREVIEWS Y ELIMINAR ARCHIVOS SELECCIONADOS (input name="imagenes") ----
    const input = document.getElementById('id_imagenes');
    const previews = document.getElementById('previews');

    function renderPreviews(){
        previews.innerHTML = '';
        if(!input.files || input.files.length === 0) return;

        Array.from(input.files).forEach((file, index) => {
            const url = URL.createObjectURL(file);

            const wrapper = document.createElement('div');
            wrapper.classList.add('position-relative');

            const img = document.createElement('img');
            img.src = url;
            img.classList.add('img-thumbnail');
            img.style.width = '120px';
            img.style.height = '120px';
            img.style.objectFit = 'cover';

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.textContent = '✕';
            btn.classList.add('btn', 'btn-sm', 'btn-danger', 'position-absolute', 'top-0', 'end-0');
            btn.style.zIndex = '10';

            btn.addEventListener('click', () => {
                const dt = new DataTransfer();
                Array.from(input.files).forEach((f, i) => {
                    if(i !== index) dt.items.add(f);
                });
                input.files = dt.files;
                URL.revokeObjectURL(url);
                renderPreviews();
            });

            wrapper.appendChild(img);
            wrapper.appendChild(btn);
            previews.appendChild(wrapper);
        });
    }

    input.addEventListener('change', () => {
        renderPreviews();
    });

    renderPreviews();
})();

document.addEventListener('DOMContentLoaded', function(){
    // ---- ELIMINAR IMÁGENES EXISTENTES ----
    const contenedor = document.getElementById('imagenes_existentes');
    if(!contenedor) return;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    contenedor.addEventListener('click', function(e){
        if(e.target.classList.contains('btn-eliminar')){
            const idImagen = e.target.dataset.id;
            const wrapper = e.target.parentElement;

            if(!idImagen) return;

            if(confirm('¿Deseas eliminar esta imagen?')){
                e.target.disabled = true;

                fetch("{% url 'blog:eliminar_imagen_articulo' 0 %}".replace('0', idImagen), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                })
                .then(res => {
                    if (!res.ok) throw new Error('Respuesta no OK del servidor');
                    return res.json();
                })
                .then(data => {
                    if(data.ok){
                        wrapper.remove();
                    } else {
                        alert(data.error || 'No se pudo eliminar la imagen.');
                        e.target.disabled = false;
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Error al eliminar la imagen.');
                    e.target.disabled = false;
                });
            }
        }
    });
});
</script>
{% endblock contenido %}
