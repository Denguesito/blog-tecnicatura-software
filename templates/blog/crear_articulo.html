{% extends "base.html" %}

{% load static %}

{% block banner %}
<section class="banner banner-articulos">
  <div class="banner-content">
  </div>
</section>
{% endblock banner %}

{% block titulo %}Crear Artículo{% endblock titulo %}

{% block contenido %}
<div class="container my-5">
  <h2 class="text-center text-success mb-4">Crear Artículo</h2>

  <form method="post" enctype="multipart/form-data" class="p-4 border rounded shadow-sm bg-light">
    {% csrf_token %}

    <!-- Título -->
    <div class="mb-3">
      {{ form.titulo.label_tag }}
      {{ form.titulo }}
      {% for error in form.titulo.errors %}
        <div class="text-danger small">{{ error }}</div>
      {% endfor %}
    </div>

    <!-- Contenido -->
    <div class="mb-3">
      {{ form.contenido.label_tag }}
      {{ form.contenido }}
      {% for error in form.contenido.errors %}
        <div class="text-danger small">{{ error }}</div>
      {% endfor %}
    </div>

    <!-- Categoría -->
    <div class="mb-3">
      {{ form.categoria.label_tag }}
      {{ form.categoria }}
      {% for error in form.categoria.errors %}
        <div class="text-danger small">{{ error }}</div>
      {% endfor %}
    </div>

    <!-- Input para nuevas imágenes -->
    <div class="mb-3">
      <label for="id_imagenes" class="form-label">Imágenes:</label>
      <input type="file" id="id_imagenes" multiple accept="image/*" class="form-control mb-2">
      <div id="previews" class="d-flex flex-wrap gap-2 mb-3"></div>
      <input type="file" name="imagenes" id="imagenes_hidden" style="display:none;" multiple>
    </div>

    <!-- Botones -->
    <div class="d-flex justify-content-center gap-3 mt-4">
      <button type="submit" class="btn btn-success px-4">Guardar</button>
      <a href="{% url 'blog:lista_articulos' %}" class="btn btn-secondary px-4">Cancelar</a>
    </div>
  </form>
</div>

<script>
(function(){
    const input = document.getElementById('id_imagenes');
    const hidden = document.getElementById('imagenes_hidden');
    const previews = document.getElementById('previews');
    const dt = new DataTransfer();

    function updateHiddenAndPreviews(){
        hidden.files = dt.files;
        previews.innerHTML = '';
        for(let i=0;i<dt.files.length;i++){
            const file = dt.files[i];
            const url = URL.createObjectURL(file);

            const wrapper = document.createElement('div');
            wrapper.classList.add('position-relative');

            const img = document.createElement('img');
            img.src = url;
            img.classList.add('img-thumbnail');
            img.style.width = '120px';
            img.style.height = '120px';
            img.style.objectFit = 'cover';

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.textContent = '✕';
            btn.classList.add('btn', 'btn-sm', 'btn-danger', 'position-absolute', 'top-0', 'end-0');
            btn.style.zIndex = '10';

            btn.addEventListener('click', ()=> {
                const newDt = new DataTransfer();
                for(let j=0;j<dt.files.length;j++){
                    if(j===i) continue;
                    newDt.items.add(dt.files[j]);
                }
                while(dt.items.length) dt.items.remove(0);
                for(let k=0;k<newDt.files.length;k++) dt.items.add(newDt.files[k]);
                updateHiddenAndPreviews();
            });

            wrapper.appendChild(img);
            wrapper.appendChild(btn);
            previews.appendChild(wrapper);
        }
    }

    input.addEventListener('change', (e)=>{
        for(const file of e.target.files){
            dt.items.add(file);
        }
        input.value = '';
        updateHiddenAndPreviews();
    });
})();
</script>
{% endblock contenido %}
