{% extends "base.html" %}
{% load static %}

{% block banner %}
<section class="banner banner-articulos">
  <div class="banner-content"></div>
</section>
{% endblock banner %}

{% block contenido %}

<div class="container my-5">
  <h2 class="text-center text-primary mb-4">{{ articulo.titulo }}</h2>

  <!-- Contenido del artículo sin padding lateral -->
  <div class="container-fluid my-5 px-0">
    <div class="articulo-contenido">
      {{ articulo.contenido|linebreaksbr|urlize|safe }}
    </div>
  </div>


  {% if articulo.imagenes.all %}
  <div class="carousel-container mb-4">
    {% for imagen in articulo.imagenes.all %}
      <img src="{{ imagen.imagen.url }}" 
           alt="{{ articulo.titulo }}"
           class="img-clickable"
           data-bs-toggle="modal"
           data-bs-target="#modalImagen{{ forloop.counter }}"
      >

      <!-- Modal para cada imagen -->
      <div class="modal fade" id="modalImagen{{ forloop.counter }}" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-xl">
          <div class="modal-content bg-transparent border-0 shadow-none">
            <div class="modal-body p-0 text-center">
              <img src="{{ imagen.imagen.url }}" class="img-fluid rounded modal-img" alt="{{ articulo.titulo }}" style="width: 100%; height: 100%;">
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <span class="badge bg-info text-dark mb-3">{{ articulo.visitas }} visitas</span>

  {% if usuario_actual.is_authenticated and usuario_actual == articulo.autor or usuario_actual.is_staff or usuario_actual.is_superuser %}
    <div class="d-flex gap-2 flex-wrap mb-4">
      <a href="{% url 'blog:editar_articulo' articulo.pk %}" class="btn btn-warning">Editar</a>
      <a href="{% url 'blog:eliminar_articulo' articulo.pk %}" class="btn btn-danger">Eliminar</a>
    </div>
  {% endif %}

  <hr class="my-4">

  <h3>Comentarios</h3>
  <div class="mt-3">
    {% for comentario in comentarios %}
      <div class="border rounded p-3 mb-3">
        <strong class="text-primary">{{ comentario.autor }}</strong>
        <p class="mb-1">{{ comentario.contenido }}</p>
        {% if usuario_actual == comentario.autor or usuario_actual.is_superuser or usuario_actual.is_staff %}
          <div class="d-flex gap-2 flex-wrap">
            <a href="{% url 'comentarios:editar_comentario' comentario.pk %}" class="btn btn-sm btn-outline-warning">Editar</a>
            <a href="{% url 'comentarios:eliminar_comentario' comentario.pk %}" class="btn btn-sm btn-outline-danger">Eliminar</a>
          </div>
        {% endif %}
      </div>
    {% empty %}
      <p>No hay comentarios aún. ¡Sé el primero en comentar!</p>
    {% endfor %}
  </div>

  {% if usuario_actual.is_authenticated %}
    <hr>
    <h4 class="mt-4">Deja tu comentario</h4>
    <form action="{% url 'comentarios:agregar_comentario' articulo.pk %}" method="post" class="mt-3">
      {% csrf_token %}
      {{ form.contenido }}
      <button type="submit" class="btn btn-primary mt-2">Comentar</button>
    </form>
  {% else %}
    <p>Debes <a href="{% url 'usuarios:login' %}">iniciar sesión</a> para comentar.</p>
  {% endif %}

  <div class="mt-4 text-center">
    <a href="{% url 'blog:lista_articulos' %}" class="btn btn-secondary">Volver a posts</a>
  </div>
</div>

<!-- Script para abrir links en nueva pestaña -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll('.articulo-contenido a').forEach(a => {
        a.setAttribute('target', '_blank');
        a.setAttribute('rel', 'noopener noreferrer');
    });
});
</script>

{% endblock contenido %}
